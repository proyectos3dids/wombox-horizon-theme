{%- comment -%}
  Pills Pa√≠s/Moneda + Idioma (sin JS del tema)
  Par√°metros opcionales:
    - show_country: true/false
    - show_language: true/false
{%- endcomment -%}

{% liquid
  assign _show_country  = show_country
  assign _show_language = show_language

  if _show_country == nil or _show_country == ''
    assign _show_country = localization.available_countries.size > 1
  endif
  if _show_language == nil or _show_language == ''
    assign _show_language = localization.available_languages.size > 1
  endif

  assign cc = localization.country.iso_code | upcase
  assign cc_lc = localization.country.iso_code | downcase
  assign current_flag_asset = 'flag-' | append: cc_lc | append: '.svg'
%}

<div class="locpill-wrap" role="group" aria-label="Selecci√≥n de pa√≠s e idioma">
  {%- if _show_country -%}
    {% form 'localization', id: 'LocPillCountry', class: 'locpill locpill--xxs' %}
      <details class="locpill__details">
        <summary class="locpill__summary" aria-label="Cambiar pa√≠s y moneda">
          <span class="locpill__flag">
            {%- comment -%} Bandera SVG si existe (nombre: flag-{{cc_lc}}.svg); fallback: emoji de bandera {%- endcomment -%}
            <img class="locpill__flagimg"
                 src="{{ current_flag_asset | asset_url }}"
                 alt="{{ localization.country.name }}"
                 loading="lazy"
                 onerror="this.remove()">
            <span class="locpill__emoji">{{ cc }}</span>
          </span>
          <span class="locpill__label">{{ localization.country.name | upcase }} {{ localization.country.currency.symbol }}</span>
          <span class="locpill__chev" aria-hidden="true">‚ñæ</span>
        </summary>

        {#-- MODAL CENTRADO: Pa√≠s/Moneda --#}
        <div class="locpill__modal" aria-modal="true" role="dialog">
          <button class="locpill__overlay" type="button" data-close aria-label="Cerrar"></button>

          <div class="locpill__panel" role="document">
            <div class="locpill__head">
              <span class="locpill__title">Selecciona pa√≠s y moneda</span>
              <button class="locpill__close" type="button" data-close aria-label="Cerrar">‚úï</button>
            </div>

            <div class="locpill__options" role="listbox">
              {%- for country in localization.available_countries -%}
                {% liquid
                  assign iso_up = country.iso_code | upcase
                  assign iso_lc = country.iso_code | downcase
                  assign opt_flag_asset = 'flag-' | append: iso_lc | append: '.svg'
                %}
                <button type="submit"
                        name="country_code"
                        value="{{ country.iso_code }}"
                        class="locpill__option"
                        {% if country.iso_code == localization.country.iso_code %}aria-current="true"{% endif %}>
                  <span class="locpill__opt-flag">
                    <img class="locpill__flagimg" src="{{ opt_flag_asset | asset_url }}" alt="{{ country.name }}" loading="lazy" onerror="this.remove()">
                    <span class="locpill__tag">{{ iso_up }}</span>
                  </span>
                  <span class="locpill__opt-label">{{ country.name }} {{ country.currency.symbol }}</span>
                </button>
              {%- endfor -%}
            </div>
          </div>
        </div>
      </details>
    {% endform %}
  {%- endif -%}

  {%- if _show_language -%}
    {% form 'localization', id: 'LocPillLanguage', class: 'locpill locpill--xxs' %}
      <details class="locpill__details">
        <summary class="locpill__summary" aria-label="Cambiar idioma">
          <span class="locpill__flag"><span class="locpill__emoji">üåê</span></span>
          <span class="locpill__label">{{ localization.language.endonym_name | default: localization.language.name | upcase }}</span>
          <span class="locpill__chev" aria-hidden="true">‚ñæ</span>
        </summary>

        {#-- MODAL CENTRADO: Idioma --#}
        <div class="locpill__modal" aria-modal="true" role="dialog">
          <button class="locpill__overlay" type="button" data-close aria-label="Cerrar"></button>

          <div class="locpill__panel" role="document">
            <div class="locpill__head">
              <span class="locpill__title">Selecciona idioma</span>
              <button class="locpill__close" type="button" data-close aria-label="Cerrar">‚úï</button>
            </div>

            <div class="locpill__options" role="listbox">
              {%- for language in localization.available_languages -%}
                <button type="submit"
                        name="locale_code"
                        value="{{ language.iso_code }}"
                        class="locpill__option"
                        {% if language.iso_code == localization.language.iso_code %}aria-current="true"{% endif %}>
                  <span class="locpill__opt-label">{{ language.endonym_name | default: language.name }}</span>
                </button>
              {%- endfor -%}
            </div>
          </div>
        </div>
      </details>
    {% endform %}
  {%- endif -%}
</div>

<style>
/* ===== P√çLDORAS EN LA MISMA L√çNEA ===== */
.locpill-wrap{
  display:inline-flex; align-items:center; gap:10px; flex-wrap:nowrap; white-space:nowrap;
}
form.locpill{ display:inline-flex; width:auto !important; flex:0 0 auto; margin:0; }
.locpill__details{ display:inline-block; }
.locpill__summary{ display:inline-flex; width:auto; margin:0; white-space:nowrap; }

/* ===== Tama√±os ===== */
.locpill--sm{ --pill-h:26px; --pill-px:12px; --pill-gap:8px; --flag-size:20px; --border-w:1.6px; }
.locpill--xxs{ --pill-h:18px; --pill-px:8px; --pill-gap:6px; --flag-size:14px; --border-w:1.2px; }
.locpill--micro{ --pill-h:16px; --pill-px:6px; --pill-gap:4px; --flag-size:12px; --border-w:1px; }

/* ===== Base pill ===== */
.locpill{ position:relative; }
.locpill__summary{
  list-style:none; align-items:center; gap:var(--pill-gap);
  height:var(--pill-h); padding:0 var(--pill-px);
  border-radius:9999px; border:var(--border-w) solid #fff;
  background:rgba(255,255,255,.08);
  color:#fff; font-weight:600; text-transform:uppercase;
  font-size:10px; line-height:1; cursor:pointer; -webkit-tap-highlight-color:transparent;
}
.locpill--sm .locpill__summary{ font-size:12px; }
.locpill--micro .locpill__summary{ font-size:9px; }
.locpill__summary::-webkit-details-marker{ display:none; }

.locpill__flag{ width:var(--flag-size); height:var(--flag-size); border-radius:9999px; overflow:hidden; display:grid; place-items:center; flex:0 0 var(--flag-size); }
.locpill__flagimg{ width:100%; height:100%; object-fit:cover; display:block; }
.locpill__emoji{ font-size:11px; line-height:1; } /* fallback si no hay SVG */

.locpill__label{ white-space:nowrap; }
.locpill__chev{ margin-left:auto; font-size:9px; transition:transform .2s; }
.locpill__details[open] .locpill__chev{ transform:rotate(180deg); }

/* ===== MODAL CENTRADO ===== */
.locpill__modal{ position:fixed; inset:0; display:none; z-index:999; }
.locpill__details[open] .locpill__modal{ display:flex; }

.locpill__overlay{ position:absolute; inset:0; background:rgba(0,0,0,.55); border:0; cursor:pointer; }
.locpill__panel{
  position:relative; margin:auto; width:min(720px,92vw); max-height:80vh; overflow:auto;
  background:#fff; color:#111; border-radius:16px; padding:16px;
  box-shadow:0 20px 60px rgba(0,0,0,.25);
}
.locpill__head{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px; }
.locpill__title{ font-weight:700; font-size:20px; }
.locpill__close{ background:transparent; border:0; font-size:22px; line-height:1; cursor:pointer; padding:6px; border-radius:8px; }
.locpill__close:hover{ background:#f3f3f3; }

/* Grid de opciones del modal */
.locpill__options{
  display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; padding:4px;
}
@media (min-width: 680px){
  .locpill__options{ grid-template-columns:repeat(2, 1fr); }
}

/* Opci√≥n en modal (con chip ISO y bandera si hay asset) */
.locpill__option{
  width:100%; display:flex; align-items:center; gap:10px;
  padding:12px 14px; border-radius:12px;
  background:#f5f5f5; border:none; cursor:pointer; text-align:left; font-size:14px;
}
.locpill__option:hover{ background:#efefef; }
.locpill__option[aria-current="true"]{ background:#e8e8e8; font-weight:700; }

.locpill__opt-flag{ display:inline-flex; align-items:center; gap:8px; min-width:56px; }
.locpill__tag{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:32px; height:24px; padding:0 8px; border-radius:8px;
  background:#fff; color:#111; font-weight:700; font-size:13px; border:1px solid #e5e5e5;
}

/* Accesibilidad */
.locpill__summary:focus-visible, .locpill__option:focus-visible{ outline:2px solid #fff; outline-offset:2px; }
html.locpill--modal-open, body.locpill--modal-open{ overflow:hidden; }

/* Scroll horizontal si el viewport es MUY estrecho */
@media (max-width: 380px){
  .locpill-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
}
</style>

<script>
/* ===== Comportamiento del modal (ligero y sin dependencias) ===== */
(function(){
  // Cerrar al pulsar overlay o la X
  document.addEventListener('click', function(ev){
    if(ev.target.matches('.locpill__overlay, .locpill__close')){
      const d = ev.target.closest('.locpill__details'); if(d) d.removeAttribute('open');
    }
  });

  // Cerrar con ESC
  document.addEventListener('keydown', function(ev){
    if(ev.key === 'Escape'){
      document.querySelectorAll('.locpill__details[open]').forEach(d=>d.removeAttribute('open'));
    }
  });

  // Bloquear/desbloquear scroll cuando hay modal abierto
  document.addEventListener('toggle', function(ev){
    if(ev.target.classList && ev.target.classList.contains('locpill__details')){
      const anyOpen = document.querySelector('.locpill__details[open]');
      document.documentElement.classList.toggle('locpill--modal-open', !!anyOpen);
      document.body.classList.toggle('locpill--modal-open', !!anyOpen);
    }
  }, true);
})();
</script>
